# **“游客止步”计划：Git 自动化同步协议 (v1.0)**

## **1\. Commit（铭刻）：记录的颗粒度**

Commit 的核心矛盾在于：记录得太细，历史会乱；记录得太粗，多端冲突的风险会指数级上升。

### **触发时机：**

* **显式触发（强制记录）：** 用户手动点击“保存/封印”按钮。  
* **环境触发（安全边界）：**  
  * **文档关闭：** 当用户从编辑页面返回目录视图时。  
  * **生命周期变更：** 应用进入后台（手机切回桌面）或锁屏。这是移动端最关键的 commit 点。  
* **定时快照（时间保障）：** \* **10 分钟心跳：** 连续编辑状态下，每 10 分钟自动 commit 一次。  
  * 注意：磁盘保存（Disk Save）是每 2 秒一次，但 Commit 只在上述节点发生。

## **2\. Pull / Fetch（感知）：外界的干预**

Pull 操作（实际上是 Fetch \+ Rebase）是防止冲突的第一道防线。

### **触发时机：**

* **启动/重连（首要）：** \* 应用冷启动时。  
  * 网络从断开恢复到连接时。  
* **主动感知（前置）：** \* **Push 之前必有 Fetch：** 在任何 Push 操作之前，系统必须先执行一次 Fetch，以确定当前本地分支是否落后。  
* **前台恢复（回滚感知）：** \* 应用从后台切回前台（例如下午在电脑写完，晚上打开手机）。

## **3\. Push（同步）：灵魂的上传**

Push 是最耗能、最依赖网络且最容易产生冲突的动作。

### **触发时机：**

* **即时同步：** 每次 Commit 成功后，如果网络在线，立即在后台启动 Push 进程。  
* **清仓同步：** 应用检测到即将被系统完全杀掉（App Terminate）前，尝试最后一次同步。  
* **队列重试：** 如果 Push 失败（因离线），将该任务放入任务队列。网络恢复后，按照时间顺序重放。

## **4\. 核心逻辑流：一个典型的“多端无缝”闭环**

我们将整个逻辑串联起来，模拟你朋友的一天：

1. **【14:00 手机端】** 开启应用。  
   * 触发 Fetch。确认本地是最新的。  
2. **【14:05 手机端】** 写了 500 字，突然有电话。  
   * 切出应用。触发 Commit \+ 后台异步 Push。  
3. **【14:30 电脑端】** 打开应用。  
   * 启动即触发 Fetch。发现远程有新 commit（即刚才手机写的）。  
   * 静默执行 Rebase。用户看到文章时，那 500 字已经在那了。  
4. **【14:40 电脑端】** 在同一篇文章下继续写。写完直接关掉。  
   * 关闭页面触发 Commit \+ Push。  
5. **【15:00 手机端】** 再次打开。  
   * 重复上述过程。如果手机端刚才没关，此时回到前台触发 Fetch。  
   * **冲突处理：** 如果手机刚才在离线状态也写了东西，导致 Rebase 失败。  
   * **自动分身：** 创建 conflict/20260113-1500 分支，推送到远程。本地 main 重置。提示用户：“检测到时空偏移，已为您保留本地副本。”

## **5\. 性能优化建议**

* **静默重试：** Push 操作不应弹窗，不应阻断 UI。使用 Tauri 的 spawn 在后台静默运行。  
* **增量上传：** 由于文件是加密的块，Git 本身就会只上传改变的文件，这已经很高效了。  
* **状态指示灯：** 在 UI 角落用一个非常小的点表示同步状态：  
  * **呼吸绿：** 正在同步。  
  * **静止灰：** 已是最新。  
  * **警告红：** 存在冲突/需要授权。