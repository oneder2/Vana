name: Build and Release

on:
  push:
    tags:
      - "v*"

permissions:
  contents: write

jobs:
  build-linux:
    name: Build Linux
    runs-on: ubuntu-22.04
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Extract version from tag
        id: version
        run: |
          TAG_NAME="${{ github.ref_name }}"
          # ç§»é™¤ 'v' å‰ç¼€ï¼Œæå–ç‰ˆæœ¬å·
          VERSION="${TAG_NAME#v}"
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "Extracted version: $VERSION"

      - name: Update version in source files
        run: |
          VERSION="${{ steps.version.outputs.version }}"
          echo "Updating version to: $VERSION"
          # æ›´æ–° package.json
          npm version $VERSION --no-git-tag-version
          # æ›´æ–° Cargo.toml
          sed -i "s/^version = \".*\"/version = \"$VERSION\"/" src-tauri/Cargo.toml
          # æ›´æ–° tauri.conf.json (éœ€è¦ jq)
          npm install -g jq
          jq ".version = \"$VERSION\"" src-tauri/tauri.conf.json > tmp.json && mv tmp.json src-tauri/tauri.conf.json
          echo "âœ… Version updated in all source files"

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20"
          cache: "npm"

      - name: Setup Rust
        uses: dtolnay/rust-toolchain@stable

      - name: Cache Rust dependencies
        uses: actions/cache@v4
        with:
          path: |
            ~/.cargo/bin/
            ~/.cargo/registry/index/
            ~/.cargo/registry/cache/
            ~/.cargo/git/db/
            src-tauri/target/
          key: ${{ runner.os }}-cargo-${{ hashFiles('**/Cargo.lock') }}
          restore-keys: |
            ${{ runner.os }}-cargo-

      - name: Install Linux dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            libwebkit2gtk-4.1-dev \
            libgtk-3-dev \
            libayatana-appindicator3-dev \
            librsvg2-dev \
            patchelf \
            build-essential \
            pkg-config \
            curl \
            wget \
            file

      - name: Verify dependencies
        run: |
          echo "Checking installed dependencies..."
          dpkg -l | grep -E "(libwebkit2gtk|libgtk-3|libayatana|librsvg|patchelf)" || exit 1
          which patchelf || exit 1
          echo "All dependencies verified"

      - name: Install frontend dependencies
        run: npm ci

      - name: Build Tauri app
        run: npm run tauri:build

      - name: Upload Linux artifacts
        uses: actions/upload-artifact@v4
        with:
          name: linux-artifacts
          path: |
            src-tauri/target/release/bundle/**/*.deb
            src-tauri/target/release/bundle/**/*.AppImage
            src-tauri/target/release/bundle/**/*.rpm
          retention-days: 30

  build-windows:
    name: Build Windows (Signed)
    runs-on: windows-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Extract version from tag
        id: version
        shell: pwsh
        run: |
          $TAG_NAME = "${{ github.ref_name }}"
          # ç§»é™¤ 'v' å‰ç¼€ï¼Œæå–ç‰ˆæœ¬å·
          $VERSION = $TAG_NAME -replace '^v', ''
          Write-Host "Extracted version: $VERSION"
          
          # å¯¹äºŽ MSIï¼Œéœ€è¦ major.minor.patch.build æ ¼å¼
          # å¦‚æžœæ˜¯é¢„å‘å¸ƒç‰ˆæœ¬ï¼ˆå¦‚ v0.5.2-beta.1ï¼‰ï¼Œæå– build å·
          $MSI_VERSION = $VERSION
          if ($TAG_NAME -match 'beta\.(\d+)$') {
            $BUILD_NUM = $matches[1]
            $MSI_VERSION = "$VERSION.$BUILD_NUM"
          } elseif ($TAG_NAME -match 'alpha\.(\d+)$') {
            $BUILD_NUM = $matches[1]
            $MSI_VERSION = "$VERSION.$BUILD_NUM"
          } elseif ($TAG_NAME -match 'rc\.(\d+)$') {
            $BUILD_NUM = $matches[1]
            $MSI_VERSION = "$VERSION.$BUILD_NUM"
          } else {
            # æ­£å¼å‘å¸ƒï¼Œbuild å·ä¸º 0
            $MSI_VERSION = "$VERSION.0"
          }
          Write-Host "MSI version: $MSI_VERSION"
          # ä½¿ç”¨ GitHub Actions è¾“å‡ºæ ¼å¼
          "version=$VERSION" | Out-File -FilePath $env:GITHUB_OUTPUT -Append
          "msi_version=$MSI_VERSION" | Out-File -FilePath $env:GITHUB_OUTPUT -Append

      - name: Update version in source files
        run: |
          $VERSION = "${{ steps.version.outputs.version }}"
          $MSI_VERSION = "${{ steps.version.outputs.msi_version }}"
          Write-Host "Updating version to: $VERSION (MSI: $MSI_VERSION)"
          
          # æ›´æ–° package.json
          $packageJson = Get-Content package.json | ConvertFrom-Json
          $packageJson.version = $VERSION
          $packageJson | ConvertTo-Json -Depth 10 | Set-Content package.json
          
          # æ›´æ–° Cargo.toml
          (Get-Content src-tauri/Cargo.toml) -replace '^version = ".*"', "version = `"$VERSION`"" | Set-Content src-tauri/Cargo.toml
          
          # æ›´æ–° tauri.conf.jsonï¼ˆä¿æŒ semver æ ¼å¼ï¼‰
          $tauriConfig = Get-Content src-tauri/tauri.conf.json | ConvertFrom-Json
          $tauriConfig.version = $VERSION
          # è®¾ç½® Windows MSI ç‰ˆæœ¬å·ï¼ˆå¦‚æžœæ”¯æŒï¼‰
          if (-not $tauriConfig.bundle.windows) {
            $tauriConfig.bundle.windows = @{}
          }
          $tauriConfig.bundle.windows.version = $MSI_VERSION
          $tauriConfig | ConvertTo-Json -Depth 10 | Set-Content src-tauri/tauri.conf.json
          
          Write-Host "âœ… Version updated: $VERSION (MSI: $MSI_VERSION)"

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20"
          cache: "npm"

      - name: Setup Rust
        uses: dtolnay/rust-toolchain@stable

      - name: Cache Rust dependencies
        uses: actions/cache@v4
        with:
          path: |
            C:\Users\runneradmin\.cargo\bin\
            C:\Users\runneradmin\.cargo\registry\index\
            C:\Users\runneradmin\.cargo\registry\cache\
            C:\Users\runneradmin\.cargo\git\db\
            src-tauri\target\
          key: ${{ runner.os }}-cargo-${{ hashFiles('**/Cargo.lock') }}
          restore-keys: |
            ${{ runner.os }}-cargo-

      - name: Import Windows certificate
        env:
          WINDOWS_CERTIFICATE: ${{ secrets.WINDOWS_CERTIFICATE }}
          WINDOWS_CERTIFICATE_PASSWORD: ${{ secrets.WINDOWS_CERTIFICATE_PASSWORD }}
        run: |
          if (-not (Test-Path certificate)) {
            New-Item -ItemType Directory -Path certificate
          }
          # Decode base64 certificate
          [System.IO.File]::WriteAllBytes(
            "$PWD\certificate\certificate.pfx",
            [System.Convert]::FromBase64String($env:WINDOWS_CERTIFICATE)
          )
          # Import certificate to CurrentUser\My store
          $securePassword = ConvertTo-SecureString -String $env:WINDOWS_CERTIFICATE_PASSWORD -Force -AsPlainText
          Import-PfxCertificate `
            -FilePath "$PWD\certificate\certificate.pfx" `
            -CertStoreLocation Cert:\CurrentUser\My `
            -Password $securePassword `
            -ErrorAction Stop
          Write-Host "Certificate imported successfully"
          # Clean up certificate file immediately
          Remove-Item -Path "$PWD\certificate\certificate.pfx" -Force
          Remove-Item -Path "$PWD\certificate" -Force

      - name: Install frontend dependencies
        run: npm ci

      - name: Build Tauri app
        env:
          # Tauri will use the imported certificate for signing
          WINDOWS_CERTIFICATE_THUMBPRINT: ${{ secrets.WINDOWS_CERTIFICATE_THUMBPRINT }}
        run: npm run tauri:build

      - name: Upload Windows artifacts
        uses: actions/upload-artifact@v4
        with:
          name: windows-artifacts
          path: |
            src-tauri/target/release/bundle/**/*.exe
            src-tauri/target/release/bundle/**/*.msi
          retention-days: 30

  build-android:
    name: Build Android (APK)
    runs-on: ubuntu-22.04
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Extract version from tag
        id: version
        run: |
          TAG_NAME="${{ github.ref_name }}"
          # ç§»é™¤ 'v' å‰ç¼€ï¼Œæå–ç‰ˆæœ¬å·
          VERSION="${TAG_NAME#v}"
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "Extracted version: $VERSION"

      - name: Update version in source files
        run: |
          VERSION="${{ steps.version.outputs.version }}"
          echo "Updating version to: $VERSION"
          # æ›´æ–° package.json
          npm version $VERSION --no-git-tag-version
          # æ›´æ–° Cargo.toml
          sed -i "s/^version = \".*\"/version = \"$VERSION\"/" src-tauri/Cargo.toml
          # æ›´æ–° tauri.conf.json (éœ€è¦ jq)
          npm install -g jq
          jq ".version = \"$VERSION\"" src-tauri/tauri.conf.json > tmp.json && mv tmp.json src-tauri/tauri.conf.json
          echo "âœ… Version updated in all source files"

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20"
          cache: "npm"

      - name: Setup Rust
        uses: dtolnay/rust-toolchain@stable

      - name: Cache Rust dependencies
        uses: actions/cache@v4
        with:
          path: |
            ~/.cargo/bin/
            ~/.cargo/registry/index/
            ~/.cargo/registry/cache/
            ~/.cargo/git/db/
            src-tauri/target/
          key: ${{ runner.os }}-cargo-${{ hashFiles('**/Cargo.lock') }}
          restore-keys: |
            ${{ runner.os }}-cargo-

      - name: Setup Java JDK
        uses: actions/setup-java@v4
        with:
          distribution: "temurin"
          java-version: "17"

      - name: Setup Android SDK
        uses: android-actions/setup-android@v3

      - name: Install Android dependencies
        run: |
          # Accept Android SDK licenses
          yes | sdkmanager --licenses || true
          # Install required Android SDK components
          sdkmanager "platform-tools" "platforms;android-33" "build-tools;33.0.1"
          
          # 1. è‡ªåŠ¨èŽ·å–å½“å‰ç³»ç»Ÿä¸­ç”Ÿæ•ˆçš„ NDK è·¯å¾„ï¼ˆç”± tauri è¯†åˆ«åˆ°çš„ç‰ˆæœ¬ä¸ºå‡†ï¼‰
          # æˆ‘ä»¬ä¸å†æ‰‹åŠ¨ä¸‹è½½ç‰¹å®šç‰ˆæœ¬ï¼Œè€Œæ˜¯ç›´æŽ¥ä½¿ç”¨ç³»ç»Ÿè·¯å¾„
          NDK_PATH=$(ls -d $ANDROID_HOME/ndk/* 2>/dev/null | tail -1)
          if [ -z "$NDK_PATH" ]; then
            # å¦‚æžœæ²¡æœ‰æ‰¾åˆ°ï¼Œå®‰è£…ä¸€ä¸ªé»˜è®¤ç‰ˆæœ¬
            sdkmanager "ndk;25.2.9519653"
            NDK_PATH="$ANDROID_HOME/ndk/25.2.9519653"
          fi
          echo "Using NDK at: $NDK_PATH"
          
          # 2. æž„é€  LLVM å·¥å…·é“¾è·¯å¾„
          TOOLCHAIN_PATH="$NDK_PATH/toolchains/llvm/prebuilt/linux-x86_64/bin"
          
          # 3. æ ¸å¿ƒä¿®å¤ï¼šæ‰‹åŠ¨åˆ›å»ºç¼ºå¤±çš„ç¬¦å·é“¾æŽ¥
          # æŸäº›ç‰ˆæœ¬çš„ NDK å°† ranlib å‘½åä¸º llvm-ranlibï¼Œè€Œ OpenSSL è„šæœ¬åœ¨æ‰¾ aarch64-linux-android-ranlib
          if [ -d "$TOOLCHAIN_PATH" ]; then
            cd "$TOOLCHAIN_PATH"
            sudo ln -sf llvm-ranlib aarch64-linux-android-ranlib || true
            sudo ln -sf llvm-ar aarch64-linux-android-ar || true
            sudo ln -sf llvm-ranlib armv7a-linux-androideabi-ranlib || true
            sudo ln -sf llvm-ar armv7a-linux-androideabi-ar || true
            sudo ln -sf llvm-ranlib i686-linux-android-ranlib || true
            sudo ln -sf llvm-ar i686-linux-android-ar || true
            sudo ln -sf llvm-ranlib x86_64-linux-android-ranlib || true
            sudo ln -sf llvm-ar x86_64-linux-android-ar || true
          fi
          
          # 4. å†™å…¥çŽ¯å¢ƒå˜é‡
          echo "ANDROID_HOME=$ANDROID_HOME" >> $GITHUB_ENV
          echo "ANDROID_SDK_ROOT=$ANDROID_HOME" >> $GITHUB_ENV
          echo "NDK_HOME=$NDK_PATH" >> $GITHUB_ENV
          echo "$TOOLCHAIN_PATH" >> $GITHUB_PATH
          echo "PATH=$ANDROID_HOME/platform-tools:$ANDROID_HOME/tools/bin:$TOOLCHAIN_PATH:$PATH" >> $GITHUB_ENV
          
          # 5. å¼ºåˆ¶å‘ŠçŸ¥ OpenSSL ä½¿ç”¨æ­£ç¡®çš„ RANLIB
          echo "RANLIB=aarch64-linux-android-ranlib" >> $GITHUB_ENV
          echo "AR=aarch64-linux-android-ar" >> $GITHUB_ENV

      - name: Add Rust Android targets
        run: |
          rustup target add aarch64-linux-android
          rustup target add armv7-linux-androideabi
          rustup target add x86_64-linux-android
          rustup target add i686-linux-android

      - name: Setup Android keystore
        run: |
          mkdir -p android-keystore
          # Decode base64 keystore
          echo "${{ secrets.ANDROID_KEYSTORE_BASE64 }}" | base64 -d > android-keystore/keystore.jks
          # Create keystore.properties for Gradle
          mkdir -p src-tauri/gen/android/app
          cat > src-tauri/gen/android/app/keystore.properties << EOF
          keyAlias=${{ secrets.ANDROID_KEY_ALIAS }}
          keyPassword=${{ secrets.ANDROID_KEY_PASSWORD }}
          storeFile=$PWD/android-keystore/keystore.jks
          storePassword=${{ secrets.ANDROID_KEYSTORE_PASSWORD }}
          EOF
          # Clean up keystore file after build (handled in cleanup step)

      - name: Install frontend dependencies
        run: npm ci

      - name: Initialize Android project
        run: |
          echo "ðŸ“± Initializing Android project..."
          if [ ! -d "src-tauri/gen/android" ]; then
            npx tauri android init
            echo "âœ… Android project initialized"
          else
            echo "âœ… Android project already exists"
          fi

      - name: Build Android APK
        run: |
          echo "ðŸ”¨ Building Android release APK..."
          # Tauri android build defaults to release mode
          # Use --verbose for detailed output
          # Note: --apk and --release flags are not needed (default behavior)
          # æ˜¾å¼æ³¨å…¥çŽ¯å¢ƒå˜é‡ï¼Œé˜²æ­¢ openssl-sys ä¹±æ‰¾å·¥å…·
          export AR=aarch64-linux-android-ar
          export RANLIB=aarch64-linux-android-ranlib
          # æ˜¾å¼æŒ‡å®š target ä»¥å‡å°‘ç¼–è¯‘å™¨çš„æ··æ·†
          # Tauri CLI ä½¿ç”¨æž¶æž„ç¼©å†™ï¼Œä¼šè‡ªåŠ¨æ˜ å°„åˆ°å®Œæ•´çš„ target triple
          npx tauri android build --target aarch64 --verbose
          
          echo "âœ… Build completed, checking outputs..."

      - name: Debug - List build outputs
        run: |
          echo "ðŸ“¦ Searching for APK/AAB files..."
          echo ""
          echo "=== Checking APK outputs ==="
          find src-tauri/gen/android -type f -name "*.apk" 2>/dev/null | head -20 || echo "No APK files found"
          echo ""
          echo "=== Checking AAB outputs ==="
          find src-tauri/gen/android -type f -name "*.aab" 2>/dev/null | head -20 || echo "No AAB files found"
          echo ""
          echo "=== Common output directories ==="
          ls -la src-tauri/gen/android/app/build/outputs/apk/ 2>/dev/null || echo "APK directory not found"
          ls -la src-tauri/gen/android/app/build/outputs/bundle/ 2>/dev/null || echo "Bundle directory not found"
          echo ""
          echo "=== Full outputs directory structure ==="
          find src-tauri/gen/android/app/build/outputs -type f 2>/dev/null | head -30 || echo "Outputs directory not found"

      - name: Upload Android artifacts
        uses: actions/upload-artifact@v4
        with:
          name: android-artifacts
          path: |
            src-tauri/gen/android/**/*.apk
            src-tauri/gen/android/**/*.aab
          if-no-files-found: warn
          retention-days: 30

      - name: Cleanup keystore
        if: always()
        run: |
          rm -rf android-keystore
          rm -f src-tauri/gen/android/app/keystore.properties

  create-release:
    name: Create GitHub Release
    needs: [build-linux, build-windows, build-android]
    runs-on: ubuntu-latest
    if: startsWith(github.ref, 'refs/tags/')
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts

      - name: List downloaded artifacts
        run: |
          echo "ðŸ“¦ Downloaded artifacts structure:"
          find artifacts -type f \( -name "*.apk" -o -name "*.aab" -o -name "*.deb" -o -name "*.AppImage" -o -name "*.rpm" -o -name "*.exe" -o -name "*.msi" \) | head -30 || echo "No artifacts found"

      - name: Validate build artifacts
        id: validate
        run: |
          echo "ðŸ” Validating build artifacts..."
          
          # æ£€æŸ¥å¿…éœ€çš„æ–‡ä»¶
          REQUIRED_PATTERNS=(
            "artifacts/linux-artifacts/**/*.deb"
            "artifacts/linux-artifacts/**/*.AppImage"
            "artifacts/windows-artifacts/**/*.exe"
            "artifacts/windows-artifacts/**/*.msi"
            "artifacts/android-artifacts/**/*.apk"
          )
          
          MISSING_FILES=()
          for pattern in "${REQUIRED_PATTERNS[@]}"; do
            if ! ls $pattern 1> /dev/null 2>&1; then
              MISSING_FILES+=("$pattern")
            fi
          done
          
          if [ ${#MISSING_FILES[@]} -gt 0 ]; then
            echo "âŒ Missing required artifacts:"
            printf '%s\n' "${MISSING_FILES[@]}"
            echo "valid=false" >> $GITHUB_OUTPUT
            exit 1
          fi
          
          # éªŒè¯æ–‡ä»¶å¤§å°ï¼ˆè‡³å°‘ 1MBï¼‰
          echo "ðŸ“Š Checking file sizes..."
          find artifacts -type f \( -name "*.deb" -o -name "*.AppImage" -o -name "*.rpm" -o -name "*.exe" -o -name "*.msi" -o -name "*.apk" -o -name "*.aab" \) | while read file; do
            if [ -f "$file" ]; then
              SIZE=$(stat -c%s "$file" 2>/dev/null || echo "0")
              SIZE_MB=$((SIZE / 1024 / 1024))
              if [ $SIZE_MB -lt 1 ]; then
                echo "âš ï¸ Warning: $file is suspiciously small (${SIZE_MB}MB)"
              else
                echo "âœ… $file: ${SIZE_MB}MB"
              fi
            fi
          done
          
          echo "âœ… All artifacts validated"
          echo "valid=true" >> $GITHUB_OUTPUT

      - name: Determine release type
        id: release-type
        run: |
          TAG_NAME="${{ github.ref_name }}"
          if [[ "$TAG_NAME" == *"beta"* ]] || [[ "$TAG_NAME" == *"alpha"* ]] || [[ "$TAG_NAME" == *"rc"* ]]; then
            echo "prerelease=true" >> $GITHUB_OUTPUT
          else
            echo "prerelease=false" >> $GITHUB_OUTPUT
          fi

      - name: Create Release (Draft)
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ github.ref_name }}
          name: "No Visitors ${{ github.ref_name }}"
          body: |
            ## Release ${{ github.ref_name }}
            
            Automated release build for No Visitors.
            
            ### Downloads
            - **Linux**: .deb, .AppImage, or .rpm packages
            - **Windows**: .exe or .msi installer (signed)
            - **Android**: Release APK
            
            ### Build Information
            - Commit: ${{ github.sha }}
            - Workflow: ${{ github.workflow }}
            - Run ID: ${{ github.run_id }}
            - Validation: ${{ steps.validate.outputs.valid }}
            
            > **Note**: This is a draft release. Please verify all artifacts before publishing.
          draft: true
          prerelease: ${{ steps.release-type.outputs.prerelease }}
          files: |
            artifacts/linux-artifacts/**/*
            artifacts/windows-artifacts/**/*
            artifacts/android-artifacts/**/*
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Check Slack webhook
        id: check-slack
        run: |
          if [ -n "${{ secrets.SLACK_WEBHOOK_URL }}" ]; then
            echo "has_webhook=true" >> $GITHUB_OUTPUT
          else
            echo "has_webhook=false" >> $GITHUB_OUTPUT
          fi

      - name: Notify release created
        if: always() && steps.check-slack.outputs.has_webhook == 'true'
        uses: 8398a7/action-slack@v3
        with:
          status: ${{ job.status }}
          text: |
            ðŸš€ Release ${{ github.ref_name }} created (Draft)!
            Version: ${{ github.ref_name }}
            Commit: ${{ github.sha }}
            Validation: ${{ steps.validate.outputs.valid }}
            Please review and publish manually.
          webhook_url: ${{ secrets.SLACK_WEBHOOK_URL }}
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}

