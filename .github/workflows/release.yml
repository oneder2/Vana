name: Build and Release

on:
  push:
    tags:
      - "v*"

permissions:
  contents: write

jobs:
  build-linux:
    name: Build Linux
    runs-on: ubuntu-22.04
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20"
          cache: "npm"

      - name: Setup Rust
        uses: dtolnay/rust-toolchain@stable

      - name: Install Linux dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            libwebkit2gtk-4.1-dev \
            libgtk-3-dev \
            libayatana-appindicator3-dev \
            librsvg2-dev \
            patchelf \
            build-essential \
            pkg-config \
            curl \
            wget \
            file

      - name: Verify dependencies
        run: |
          echo "Checking installed dependencies..."
          dpkg -l | grep -E "(libwebkit2gtk|libgtk-3|libayatana|librsvg|patchelf)" || exit 1
          which patchelf || exit 1
          echo "All dependencies verified"

      - name: Install frontend dependencies
        run: npm ci

      - name: Build Tauri app
        run: npm run tauri:build

      - name: Upload Linux artifacts
        uses: actions/upload-artifact@v4
        with:
          name: linux-artifacts
          path: |
            src-tauri/target/release/bundle/**/*.deb
            src-tauri/target/release/bundle/**/*.AppImage
            src-tauri/target/release/bundle/**/*.rpm
          retention-days: 30

  build-windows:
    name: Build Windows (Signed)
    runs-on: windows-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20"
          cache: "npm"

      - name: Setup Rust
        uses: dtolnay/rust-toolchain@stable

      - name: Import Windows certificate
        env:
          WINDOWS_CERTIFICATE: ${{ secrets.WINDOWS_CERTIFICATE }}
          WINDOWS_CERTIFICATE_PASSWORD: ${{ secrets.WINDOWS_CERTIFICATE_PASSWORD }}
        run: |
          if (-not (Test-Path certificate)) {
            New-Item -ItemType Directory -Path certificate
          }
          # Decode base64 certificate
          [System.IO.File]::WriteAllBytes(
            "$PWD\certificate\certificate.pfx",
            [System.Convert]::FromBase64String($env:WINDOWS_CERTIFICATE)
          )
          # Import certificate to CurrentUser\My store
          $securePassword = ConvertTo-SecureString -String $env:WINDOWS_CERTIFICATE_PASSWORD -Force -AsPlainText
          Import-PfxCertificate `
            -FilePath "$PWD\certificate\certificate.pfx" `
            -CertStoreLocation Cert:\CurrentUser\My `
            -Password $securePassword `
            -ErrorAction Stop
          Write-Host "Certificate imported successfully"
          # Clean up certificate file immediately
          Remove-Item -Path "$PWD\certificate\certificate.pfx" -Force
          Remove-Item -Path "$PWD\certificate" -Force

      - name: Install frontend dependencies
        run: npm ci

      - name: Build Tauri app
        env:
          # Tauri will use the imported certificate for signing
          WINDOWS_CERTIFICATE_THUMBPRINT: ${{ secrets.WINDOWS_CERTIFICATE_THUMBPRINT }}
        run: npm run tauri:build

      - name: Upload Windows artifacts
        uses: actions/upload-artifact@v4
        with:
          name: windows-artifacts
          path: |
            src-tauri/target/release/bundle/**/*.exe
            src-tauri/target/release/bundle/**/*.msi
          retention-days: 30

  build-android:
    name: Build Android (APK)
    runs-on: ubuntu-22.04
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20"
          cache: "npm"

      - name: Setup Rust
        uses: dtolnay/rust-toolchain@stable

      - name: Setup Java JDK
        uses: actions/setup-java@v4
        with:
          distribution: "temurin"
          java-version: "17"

      - name: Setup Android SDK
        uses: android-actions/setup-android@v3

      - name: Install Android dependencies
        run: |
          # Accept Android SDK licenses
          yes | sdkmanager --licenses || true
          # Install required Android SDK components
          sdkmanager "platform-tools" "platforms;android-33" "build-tools;33.0.1" "ndk;25.2.9519653"
          # Set environment variables
          echo "ANDROID_HOME=$ANDROID_HOME" >> $GITHUB_ENV
          echo "ANDROID_SDK_ROOT=$ANDROID_HOME" >> $GITHUB_ENV
          echo "NDK_HOME=$ANDROID_HOME/ndk/25.2.9519653" >> $GITHUB_ENV
          echo "PATH=$ANDROID_HOME/platform-tools:$ANDROID_HOME/tools/bin:$PATH" >> $GITHUB_ENV

      - name: Add Rust Android targets
        run: |
          rustup target add aarch64-linux-android
          rustup target add armv7-linux-androideabi
          rustup target add x86_64-linux-android
          rustup target add i686-linux-android

      - name: Setup Android keystore
        run: |
          mkdir -p android-keystore
          # Decode base64 keystore
          echo "${{ secrets.ANDROID_KEYSTORE_BASE64 }}" | base64 -d > android-keystore/keystore.jks
          # Create keystore.properties for Gradle
          mkdir -p src-tauri/gen/android/app
          cat > src-tauri/gen/android/app/keystore.properties << EOF
          keyAlias=${{ secrets.ANDROID_KEY_ALIAS }}
          keyPassword=${{ secrets.ANDROID_KEY_PASSWORD }}
          storeFile=$PWD/android-keystore/keystore.jks
          storePassword=${{ secrets.ANDROID_KEYSTORE_PASSWORD }}
          EOF
          # Clean up keystore file after build (handled in cleanup step)

      - name: Install frontend dependencies
        run: npm ci

      - name: Check Android project structure
        run: |
          echo "ðŸ“ Checking Android project structure..."
          if [ -d "src-tauri/gen/android" ]; then
            echo "âœ… Android project exists"
            find src-tauri/gen/android -type d -maxdepth 3 | head -20 || true
          else
            echo "âš ï¸ Android project not found, will be initialized during build"
          fi

      - name: Build Android APK
        run: |
          echo "ðŸ”¨ Building Android release APK..."
          # Tauri android build defaults to release mode
          # Use --verbose for detailed output
          # Note: --apk and --release flags are not needed (default behavior)
          npx tauri android build --verbose
          
          echo "âœ… Build completed, checking outputs..."

      - name: Debug - List build outputs
        run: |
          echo "ðŸ“¦ Searching for APK/AAB files..."
          echo ""
          echo "=== Checking APK outputs ==="
          find src-tauri/gen/android -type f -name "*.apk" 2>/dev/null | head -20 || echo "No APK files found"
          echo ""
          echo "=== Checking AAB outputs ==="
          find src-tauri/gen/android -type f -name "*.aab" 2>/dev/null | head -20 || echo "No AAB files found"
          echo ""
          echo "=== Common output directories ==="
          ls -la src-tauri/gen/android/app/build/outputs/apk/ 2>/dev/null || echo "APK directory not found"
          ls -la src-tauri/gen/android/app/build/outputs/bundle/ 2>/dev/null || echo "Bundle directory not found"
          echo ""
          echo "=== Full outputs directory structure ==="
          find src-tauri/gen/android/app/build/outputs -type f 2>/dev/null | head -30 || echo "Outputs directory not found"

      - name: Upload Android artifacts
        uses: actions/upload-artifact@v4
        with:
          name: android-artifacts
          path: |
            src-tauri/gen/android/**/*.apk
            src-tauri/gen/android/**/*.aab
          if-no-files-found: warn
          retention-days: 30

      - name: Cleanup keystore
        if: always()
        run: |
          rm -rf android-keystore
          rm -f src-tauri/gen/android/app/keystore.properties

  create-release:
    name: Create GitHub Release
    needs: [build-linux, build-windows, build-android]
    runs-on: ubuntu-latest
    if: startsWith(github.ref, 'refs/tags/')
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts

      - name: List downloaded artifacts
        run: |
          echo "ðŸ“¦ Downloaded artifacts structure:"
          find artifacts -type f \( -name "*.apk" -o -name "*.aab" -o -name "*.deb" -o -name "*.AppImage" -o -name "*.rpm" -o -name "*.exe" -o -name "*.msi" \) | head -30 || echo "No artifacts found"

      - name: Determine release type
        id: release-type
        run: |
          TAG_NAME="${{ github.ref_name }}"
          if [[ "$TAG_NAME" == *"beta"* ]] || [[ "$TAG_NAME" == *"alpha"* ]] || [[ "$TAG_NAME" == *"rc"* ]]; then
            echo "prerelease=true" >> $GITHUB_OUTPUT
          else
            echo "prerelease=false" >> $GITHUB_OUTPUT
          fi

      - name: Create Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ github.ref_name }}
          name: "No Visitors ${{ github.ref_name }}"
          body: |
            ## Release ${{ github.ref_name }}
            
            Automated release build for No Visitors.
            
            ### Downloads
            - **Linux**: .deb, .AppImage, or .rpm packages
            - **Windows**: .exe or .msi installer (signed)
            - **Android**: Release APK
            
            ### Build Information
            - Commit: ${{ github.sha }}
            - Workflow: ${{ github.workflow }}
            - Run ID: ${{ github.run_id }}
          draft: false
          prerelease: ${{ steps.release-type.outputs.prerelease }}
          files: |
            artifacts/linux-artifacts/**/*
            artifacts/windows-artifacts/**/*
            artifacts/android-artifacts/**/*
          token: ${{ secrets.GITHUB_TOKEN }}

