name: Development Build

on:
  push:
    branches:
      - main
    paths-ignore:
      - '**.md'
      - '.gitignore'
      - 'LICENSE'

permissions:
  contents: read

jobs:
  build-linux:
    name: Build Linux (Dev)
    runs-on: ubuntu-22.04
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20"
          cache: "npm"

      - name: Setup Rust
        uses: dtolnay/rust-toolchain@stable

      - name: Cache Rust dependencies
        uses: actions/cache@v4
        with:
          path: |
            ~/.cargo/bin/
            ~/.cargo/registry/index/
            ~/.cargo/registry/cache/
            ~/.cargo/git/db/
            src-tauri/target/
          key: ${{ runner.os }}-cargo-${{ hashFiles('**/Cargo.lock') }}
          restore-keys: |
            ${{ runner.os }}-cargo-

      - name: Install Linux dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            libwebkit2gtk-4.1-dev \
            libgtk-3-dev \
            libayatana-appindicator3-dev \
            librsvg2-dev \
            patchelf \
            build-essential \
            pkg-config \
            curl \
            wget \
            file

      - name: Set build metadata version
        id: version
        run: |
          # è¯»å–å½“å‰ç‰ˆæœ¬å·
          BASE_VERSION=$(node -p "require('./package.json').version")
          BUILD_NUM="${{ github.run_number }}"
          BUILD_VERSION="${BASE_VERSION}+build.${BUILD_NUM}"
          echo "version=$BUILD_VERSION" >> $GITHUB_OUTPUT
          echo "base_version=$BASE_VERSION" >> $GITHUB_OUTPUT
          echo "build_num=$BUILD_NUM" >> $GITHUB_OUTPUT
          echo "Build version: $BUILD_VERSION"

      - name: Install frontend dependencies
        run: npm ci

      - name: Build Tauri app
        run: npm run tauri:build

      - name: Check Slack webhook
        id: check-slack
        run: |
          if [ -n "${{ secrets.SLACK_WEBHOOK_URL }}" ]; then
            echo "has_webhook=true" >> $GITHUB_OUTPUT
          else
            echo "has_webhook=false" >> $GITHUB_OUTPUT
          fi

      - name: Notify build status
        if: always() && steps.check-slack.outputs.has_webhook == 'true'
        uses: 8398a7/action-slack@v3
        with:
          status: ${{ job.status }}
          text: |
            Linux Dev Build ${{ job.status }}!
            Version: ${{ steps.version.outputs.version }}
            Run: ${{ github.run_number }}
            Commit: ${{ github.sha }}
          webhook_url: ${{ secrets.SLACK_WEBHOOK_URL }}
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}

      - name: Upload Linux artifacts
        uses: actions/upload-artifact@v4
        with:
          name: linux-dev-artifacts-${{ github.run_number }}
          path: |
            src-tauri/target/release/bundle/**/*.deb
            src-tauri/target/release/bundle/**/*.AppImage
            src-tauri/target/release/bundle/**/*.rpm
          retention-days: 7

  build-windows:
    name: Build Windows (Dev)
    runs-on: windows-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20"
          cache: "npm"

      - name: Setup Rust
        uses: dtolnay/rust-toolchain@stable

      - name: Cache Rust dependencies
        uses: actions/cache@v4
        with:
          path: |
            C:\Users\runneradmin\.cargo\bin\
            C:\Users\runneradmin\.cargo\registry\index\
            C:\Users\runneradmin\.cargo\registry\cache\
            C:\Users\runneradmin\.cargo\git\db\
            src-tauri\target\
          key: ${{ runner.os }}-cargo-${{ hashFiles('**/Cargo.lock') }}
          restore-keys: |
            ${{ runner.os }}-cargo-

      - name: Set build metadata version
        id: version
        shell: pwsh
        run: |
          # è¯»å–å½“å‰ç‰ˆæœ¬å·
          $packageJson = Get-Content package.json | ConvertFrom-Json
          $BASE_VERSION = $packageJson.version
          $BUILD_NUM = "${{ github.run_number }}"
          $BUILD_VERSION = "$BASE_VERSION+build.$BUILD_NUM"
          Write-Host "Build version: $BUILD_VERSION"
          
          # å¯¹äºŽ Windows MSIï¼Œéœ€è¦ major.minor.patch.build æ ¼å¼
          # ä½¿ç”¨ run_number ä½œä¸º build å·
          $MSI_VERSION = "$BASE_VERSION.$BUILD_NUM"
          Write-Host "MSI version: $MSI_VERSION"
          # ä½¿ç”¨ GitHub Actions è¾“å‡ºæ ¼å¼
          "version=$BUILD_VERSION" | Out-File -FilePath $env:GITHUB_OUTPUT -Append
          "base_version=$BASE_VERSION" | Out-File -FilePath $env:GITHUB_OUTPUT -Append
          "build_num=$BUILD_NUM" | Out-File -FilePath $env:GITHUB_OUTPUT -Append
          "msi_version=$MSI_VERSION" | Out-File -FilePath $env:GITHUB_OUTPUT -Append

      - name: Set MSI version for Windows build
        run: |
          $MSI_VERSION = "${{ steps.version.outputs.msi_version }}"
          Write-Host "Setting MSI version to: $MSI_VERSION"
          # æ›´æ–° tauri.conf.json ä¸º MSI å…¼å®¹æ ¼å¼
          $tauriConfig = Get-Content src-tauri/tauri.conf.json | ConvertFrom-Json
          $tauriConfig.version = $MSI_VERSION
          $tauriConfig | ConvertTo-Json -Depth 10 | Set-Content src-tauri/tauri.conf.json
          Write-Host "âœ… MSI version set: $MSI_VERSION"

      - name: Install frontend dependencies
        run: npm ci

      - name: Build Tauri app
        run: npm run tauri:build

      - name: Check Slack webhook
        id: check-slack
        shell: pwsh
        run: |
          $webhook = "${{ secrets.SLACK_WEBHOOK_URL }}"
          if ($webhook -and $webhook -ne '') {
            Write-Host "has_webhook=true" | Out-File -FilePath $env:GITHUB_OUTPUT -Append
          } else {
            Write-Host "has_webhook=false" | Out-File -FilePath $env:GITHUB_OUTPUT -Append
          }

      - name: Notify build status
        if: always() && steps.check-slack.outputs.has_webhook == 'true'
        uses: 8398a7/action-slack@v3
        with:
          status: ${{ job.status }}
          text: |
            Windows Dev Build ${{ job.status }}!
            Version: ${{ steps.version.outputs.version }}
            Run: ${{ github.run_number }}
            Commit: ${{ github.sha }}
          webhook_url: ${{ secrets.SLACK_WEBHOOK_URL }}
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}

      - name: Upload Windows artifacts
        uses: actions/upload-artifact@v4
        with:
          name: windows-dev-artifacts-${{ github.run_number }}
          path: |
            src-tauri/target/release/bundle/**/*.exe
            src-tauri/target/release/bundle/**/*.msi
          retention-days: 7

  build-android:
    name: Build Android (Dev)
    runs-on: ubuntu-22.04
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20"
          cache: "npm"

      - name: Setup Rust
        uses: dtolnay/rust-toolchain@stable

      - name: Cache Rust dependencies
        uses: actions/cache@v4
        with:
          path: |
            ~/.cargo/bin/
            ~/.cargo/registry/index/
            ~/.cargo/registry/cache/
            ~/.cargo/git/db/
            src-tauri/target/
          key: ${{ runner.os }}-cargo-${{ hashFiles('**/Cargo.lock') }}
          restore-keys: |
            ${{ runner.os }}-cargo-

      - name: Setup Java JDK
        uses: actions/setup-java@v4
        with:
          distribution: "temurin"
          java-version: "17"

      - name: Setup Android SDK
        uses: android-actions/setup-android@v3

      - name: Install Android dependencies
        run: |
          yes | sdkmanager --licenses || true
          sdkmanager "platform-tools" "platforms;android-33" "build-tools;33.0.1" "ndk;25.2.9519653"
          echo "ANDROID_HOME=$ANDROID_HOME" >> $GITHUB_ENV
          echo "ANDROID_SDK_ROOT=$ANDROID_HOME" >> $GITHUB_ENV
          echo "NDK_HOME=$ANDROID_HOME/ndk/25.2.9519653" >> $GITHUB_ENV
          echo "PATH=$ANDROID_HOME/platform-tools:$ANDROID_HOME/tools/bin:$PATH" >> $GITHUB_ENV

      - name: Add Rust Android targets
        run: |
          rustup target add aarch64-linux-android
          rustup target add armv7-linux-androideabi
          rustup target add x86_64-linux-android
          rustup target add i686-linux-android

      - name: Set build metadata version
        id: version
        run: |
          BASE_VERSION=$(node -p "require('./package.json').version")
          BUILD_NUM="${{ github.run_number }}"
          BUILD_VERSION="${BASE_VERSION}+build.${BUILD_NUM}"
          echo "version=$BUILD_VERSION" >> $GITHUB_OUTPUT
          echo "base_version=$BASE_VERSION" >> $GITHUB_OUTPUT
          echo "build_num=$BUILD_NUM" >> $GITHUB_OUTPUT
          echo "Build version: $BUILD_VERSION"

      - name: Install frontend dependencies
        run: npm ci

      - name: Build Android APK
        run: |
          echo "ðŸ”¨ Building Android development APK..."
          npx tauri android build --verbose

      - name: Check Slack webhook
        id: check-slack
        run: |
          if [ -n "${{ secrets.SLACK_WEBHOOK_URL }}" ]; then
            echo "has_webhook=true" >> $GITHUB_OUTPUT
          else
            echo "has_webhook=false" >> $GITHUB_OUTPUT
          fi

      - name: Notify build status
        if: always() && steps.check-slack.outputs.has_webhook == 'true'
        uses: 8398a7/action-slack@v3
        with:
          status: ${{ job.status }}
          text: |
            Android Dev Build ${{ job.status }}!
            Version: ${{ steps.version.outputs.version }}
            Run: ${{ github.run_number }}
            Commit: ${{ github.sha }}
          webhook_url: ${{ secrets.SLACK_WEBHOOK_URL }}
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}

      - name: Upload Android artifacts
        uses: actions/upload-artifact@v4
        with:
          name: android-dev-artifacts-${{ github.run_number }}
          path: |
            src-tauri/gen/android/**/*.apk
            src-tauri/gen/android/**/*.aab
          if-no-files-found: warn
          retention-days: 7

