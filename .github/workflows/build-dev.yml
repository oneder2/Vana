name: Development Build

on:
  push:
    branches:
      - main
    paths-ignore:
      - '**.md'
      - '.gitignore'
      - 'LICENSE'

permissions:
  contents: read

jobs:
  build-linux:
    name: Build Linux (Dev)
    runs-on: ubuntu-22.04
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20"
          cache: "npm"

      - name: Setup Rust
        uses: dtolnay/rust-toolchain@stable

      - name: Cache Rust dependencies
        uses: actions/cache@v4
        with:
          path: |
            ~/.cargo/bin/
            ~/.cargo/registry/index/
            ~/.cargo/registry/cache/
            ~/.cargo/git/db/
            src-tauri/target/
          key: ${{ runner.os }}-cargo-${{ hashFiles('**/Cargo.lock') }}
          restore-keys: |
            ${{ runner.os }}-cargo-

      - name: Install Linux dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            libwebkit2gtk-4.1-dev \
            libgtk-3-dev \
            libayatana-appindicator3-dev \
            librsvg2-dev \
            patchelf \
            build-essential \
            pkg-config \
            curl \
            wget \
            file

      - name: Set build metadata version
        id: version
        run: |
          # è¯»å–å½“å‰ç‰ˆæœ¬å·
          BASE_VERSION=$(node -p "require('./package.json').version")
          BUILD_NUM="${{ github.run_number }}"
          BUILD_VERSION="${BASE_VERSION}+build.${BUILD_NUM}"
          echo "version=$BUILD_VERSION" >> $GITHUB_OUTPUT
          echo "base_version=$BASE_VERSION" >> $GITHUB_OUTPUT
          echo "build_num=$BUILD_NUM" >> $GITHUB_OUTPUT
          echo "Build version: $BUILD_VERSION"

      - name: Install frontend dependencies
        run: npm ci

      - name: Build Tauri app
        run: npm run tauri:build

      - name: Check Slack webhook
        id: check-slack
        run: |
          if [ -n "${{ secrets.SLACK_WEBHOOK_URL }}" ]; then
            echo "has_webhook=true" >> $GITHUB_OUTPUT
          else
            echo "has_webhook=false" >> $GITHUB_OUTPUT
          fi

      - name: Notify build status
        if: always() && steps.check-slack.outputs.has_webhook == 'true'
        uses: 8398a7/action-slack@v3
        with:
          status: ${{ job.status }}
          text: |
            Linux Dev Build ${{ job.status }}!
            Version: ${{ steps.version.outputs.version }}
            Run: ${{ github.run_number }}
            Commit: ${{ github.sha }}
          webhook_url: ${{ secrets.SLACK_WEBHOOK_URL }}
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}

      - name: Upload Linux artifacts
        uses: actions/upload-artifact@v4
        with:
          name: linux-dev-artifacts-${{ github.run_number }}
          path: |
            src-tauri/target/release/bundle/**/*.deb
            src-tauri/target/release/bundle/**/*.AppImage
            src-tauri/target/release/bundle/**/*.rpm
          retention-days: 7

  build-windows:
    name: Build Windows (Dev)
    runs-on: windows-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20"
          cache: "npm"

      - name: Setup Rust
        uses: dtolnay/rust-toolchain@stable

      - name: Cache Rust dependencies
        uses: actions/cache@v4
        with:
          path: |
            C:\Users\runneradmin\.cargo\bin\
            C:\Users\runneradmin\.cargo\registry\index\
            C:\Users\runneradmin\.cargo\registry\cache\
            C:\Users\runneradmin\.cargo\git\db\
            src-tauri\target\
          key: ${{ runner.os }}-cargo-${{ hashFiles('**/Cargo.lock') }}
          restore-keys: |
            ${{ runner.os }}-cargo-

      - name: Set build metadata version
        id: version
        shell: pwsh
        run: |
          # è¯»å–å½“å‰ç‰ˆæœ¬å·
          $packageJson = Get-Content package.json | ConvertFrom-Json
          $BASE_VERSION = $packageJson.version
          $BUILD_NUM = "${{ github.run_number }}"
          $BUILD_VERSION = "$BASE_VERSION+build.$BUILD_NUM"
          Write-Host "Build version: $BUILD_VERSION"
          
          # å¯¹äº Windows MSIï¼Œéœ€è¦ major.minor.patch.build æ ¼å¼
          # ä½¿ç”¨ run_number ä½œä¸º build å·
          $MSI_VERSION = "$BASE_VERSION.$BUILD_NUM"
          Write-Host "MSI version: $MSI_VERSION"
          # ä½¿ç”¨ GitHub Actions è¾“å‡ºæ ¼å¼
          "version=$BUILD_VERSION" | Out-File -FilePath $env:GITHUB_OUTPUT -Append
          "base_version=$BASE_VERSION" | Out-File -FilePath $env:GITHUB_OUTPUT -Append
          "build_num=$BUILD_NUM" | Out-File -FilePath $env:GITHUB_OUTPUT -Append
          "msi_version=$MSI_VERSION" | Out-File -FilePath $env:GITHUB_OUTPUT -Append

      - name: Install frontend dependencies
        run: npm ci

      - name: Build Tauri app
        env:
          # Set MSI version via environment variable (Tauri will use this for MSI only)
          TAURI_WINDOWS_MSI_VERSION: ${{ steps.version.outputs.msi_version }}
        run: npm run tauri:build

      - name: Check Slack webhook
        id: check-slack
        shell: pwsh
        run: |
          $webhook = "${{ secrets.SLACK_WEBHOOK_URL }}"
          if ($webhook -and $webhook -ne '') {
            Write-Host "has_webhook=true" | Out-File -FilePath $env:GITHUB_OUTPUT -Append
          } else {
            Write-Host "has_webhook=false" | Out-File -FilePath $env:GITHUB_OUTPUT -Append
          }

      - name: Notify build status
        if: always() && steps.check-slack.outputs.has_webhook == 'true'
        uses: 8398a7/action-slack@v3
        with:
          status: ${{ job.status }}
          text: |
            Windows Dev Build ${{ job.status }}!
            Version: ${{ steps.version.outputs.version }}
            Run: ${{ github.run_number }}
            Commit: ${{ github.sha }}
          webhook_url: ${{ secrets.SLACK_WEBHOOK_URL }}
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}

      - name: Upload Windows artifacts
        uses: actions/upload-artifact@v4
        with:
          name: windows-dev-artifacts-${{ github.run_number }}
          path: |
            src-tauri/target/release/bundle/**/*.exe
            src-tauri/target/release/bundle/**/*.msi
          retention-days: 7

  build-android:
    name: Build Android (Dev)
    runs-on: ubuntu-22.04
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20"
          cache: "npm"

      - name: Setup Rust
        uses: dtolnay/rust-toolchain@stable

      - name: Cache Rust dependencies
        uses: actions/cache@v4
        with:
          path: |
            ~/.cargo/bin/
            ~/.cargo/registry/index/
            ~/.cargo/registry/cache/
            ~/.cargo/git/db/
            src-tauri/target/
          key: ${{ runner.os }}-cargo-${{ hashFiles('**/Cargo.lock') }}
          restore-keys: |
            ${{ runner.os }}-cargo-

      - name: Setup Java JDK
        uses: actions/setup-java@v4
        with:
          distribution: "temurin"
          java-version: "17"

      - name: Setup Android SDK
        uses: android-actions/setup-android@v3

      - name: Install Android dependencies
        run: |
          yes | sdkmanager --licenses || true
          sdkmanager "platform-tools" "platforms;android-33" "build-tools;33.0.1"
          
          # 1. è‡ªåŠ¨è·å–å½“å‰ç³»ç»Ÿä¸­ç”Ÿæ•ˆçš„ NDK è·¯å¾„ï¼ˆç”± tauri è¯†åˆ«åˆ°çš„ç‰ˆæœ¬ä¸ºå‡†ï¼‰
          # æˆ‘ä»¬ä¸å†æ‰‹åŠ¨ä¸‹è½½ç‰¹å®šç‰ˆæœ¬ï¼Œè€Œæ˜¯ç›´æ¥ä½¿ç”¨ç³»ç»Ÿè·¯å¾„
          NDK_PATH=$(ls -d $ANDROID_HOME/ndk/* 2>/dev/null | tail -1)
          if [ -z "$NDK_PATH" ]; then
            # å¦‚æœæ²¡æœ‰æ‰¾åˆ°ï¼Œå®‰è£…ä¸€ä¸ªé»˜è®¤ç‰ˆæœ¬
            sdkmanager "ndk;25.2.9519653"
            NDK_PATH="$ANDROID_HOME/ndk/25.2.9519653"
          fi
          echo "Using NDK at: $NDK_PATH"
          
          # 2. æ„é€  LLVM å·¥å…·é“¾è·¯å¾„
          TOOLCHAIN_PATH="$NDK_PATH/toolchains/llvm/prebuilt/linux-x86_64/bin"
          
          # 3. æ ¸å¿ƒä¿®å¤ï¼šæ‰‹åŠ¨åˆ›å»ºç¼ºå¤±çš„ç¬¦å·é“¾æ¥
          # æŸäº›ç‰ˆæœ¬çš„ NDK å°† ranlib å‘½åä¸º llvm-ranlibï¼Œè€Œ OpenSSL è„šæœ¬åœ¨æ‰¾ aarch64-linux-android-ranlib
          if [ -d "$TOOLCHAIN_PATH" ]; then
            cd "$TOOLCHAIN_PATH"
            sudo ln -sf llvm-ranlib aarch64-linux-android-ranlib || true
            sudo ln -sf llvm-ar aarch64-linux-android-ar || true
            sudo ln -sf llvm-ranlib armv7a-linux-androideabi-ranlib || true
            sudo ln -sf llvm-ar armv7a-linux-androideabi-ar || true
            sudo ln -sf llvm-ranlib i686-linux-android-ranlib || true
            sudo ln -sf llvm-ar i686-linux-android-ar || true
            sudo ln -sf llvm-ranlib x86_64-linux-android-ranlib || true
            sudo ln -sf llvm-ar x86_64-linux-android-ar || true
          fi
          
          # 4. å†™å…¥ç¯å¢ƒå˜é‡
          echo "ANDROID_HOME=$ANDROID_HOME" >> $GITHUB_ENV
          echo "ANDROID_SDK_ROOT=$ANDROID_HOME" >> $GITHUB_ENV
          echo "NDK_HOME=$NDK_PATH" >> $GITHUB_ENV
          echo "$TOOLCHAIN_PATH" >> $GITHUB_PATH
          echo "PATH=$ANDROID_HOME/platform-tools:$ANDROID_HOME/tools/bin:$TOOLCHAIN_PATH:$PATH" >> $GITHUB_ENV
          
          # 5. å¼ºåˆ¶å‘ŠçŸ¥ OpenSSL ä½¿ç”¨æ­£ç¡®çš„ RANLIB
          echo "RANLIB=aarch64-linux-android-ranlib" >> $GITHUB_ENV
          echo "AR=aarch64-linux-android-ar" >> $GITHUB_ENV

      - name: Add Rust Android targets
        run: |
          rustup target add aarch64-linux-android
          rustup target add armv7-linux-androideabi
          rustup target add x86_64-linux-android
          rustup target add i686-linux-android

      - name: Set build metadata version
        id: version
        run: |
          BASE_VERSION=$(node -p "require('./package.json').version")
          BUILD_NUM="${{ github.run_number }}"
          BUILD_VERSION="${BASE_VERSION}+build.${BUILD_NUM}"
          echo "version=$BUILD_VERSION" >> $GITHUB_OUTPUT
          echo "base_version=$BASE_VERSION" >> $GITHUB_OUTPUT
          echo "build_num=$BUILD_NUM" >> $GITHUB_OUTPUT
          echo "Build version: $BUILD_VERSION"

      - name: Install frontend dependencies
        run: npm ci

      - name: Initialize Android project
        run: |
          echo "ğŸ“± Initializing Android project..."
          if [ ! -d "src-tauri/gen/android" ]; then
            npx tauri android init
            echo "âœ… Android project initialized"
          else
            echo "âœ… Android project already exists"
          fi

      - name: Setup Android keystore (Dev Build)
        run: |
          mkdir -p android-keystore
          # Decode base64 keystore
          echo "${{ secrets.ANDROID_KEYSTORE_BASE64 }}" | base64 -d > android-keystore/keystore.jks

          # Verify keystore was created successfully
          if [ ! -f android-keystore/keystore.jks ]; then
            echo "âŒ é”™è¯¯: Keystore æ–‡ä»¶åˆ›å»ºå¤±è´¥"
            exit 1
          fi

          echo "âœ… Keystore æ–‡ä»¶å·²åˆ›å»º: $(ls -lh android-keystore/keystore.jks)"

          # Create keystore.properties for Gradle
          mkdir -p src-tauri/gen/android/app
          cat > src-tauri/gen/android/app/keystore.properties << EOF
          keyAlias=${{ secrets.ANDROID_KEY_ALIAS }}
          keyPassword=${{ secrets.ANDROID_KEY_PASSWORD }}
          storeFile=$PWD/android-keystore/keystore.jks
          storePassword=${{ secrets.ANDROID_KEYSTORE_PASSWORD }}
          EOF

          echo "âœ… keystore.properties å·²åˆ›å»º (Dev Build)"

      - name: Configure Android signing (Dev Build)
        run: |
          echo "ğŸ”§ é…ç½® Gradle ç­¾å (Dev Build)..."
          python3 scripts/configure-android-signing.py

          echo ""
          echo "ğŸ” éªŒè¯é…ç½®..."
          if grep -q "signingConfigs" src-tauri/gen/android/app/build.gradle.kts; then
            echo "âœ… ç­¾åé…ç½®å·²æˆåŠŸæ·»åŠ åˆ° build.gradle.kts"
          else
            echo "âŒ é”™è¯¯: æœªåœ¨ build.gradle.kts ä¸­æ‰¾åˆ°ç­¾åé…ç½®"
            exit 1
          fi

      - name: Build Android APK
        run: |
          echo "ğŸ”¨ Building Android development APK..."
          # æ˜¾å¼æ³¨å…¥ç¯å¢ƒå˜é‡ï¼Œé˜²æ­¢ openssl-sys ä¹±æ‰¾å·¥å…·
          export AR=aarch64-linux-android-ar
          export RANLIB=aarch64-linux-android-ranlib
          # æ˜¾å¼æŒ‡å®š target ä»¥å‡å°‘ç¼–è¯‘å™¨çš„æ··æ·†
          # Tauri CLI ä½¿ç”¨æ¶æ„ç¼©å†™ï¼Œä¼šè‡ªåŠ¨æ˜ å°„åˆ°å®Œæ•´çš„ target triple
          npx tauri android build --target aarch64 --verbose

      - name: Check Slack webhook
        id: check-slack
        run: |
          if [ -n "${{ secrets.SLACK_WEBHOOK_URL }}" ]; then
            echo "has_webhook=true" >> $GITHUB_OUTPUT
          else
            echo "has_webhook=false" >> $GITHUB_OUTPUT
          fi

      - name: Notify build status
        if: always() && steps.check-slack.outputs.has_webhook == 'true'
        uses: 8398a7/action-slack@v3
        with:
          status: ${{ job.status }}
          text: |
            Android Dev Build ${{ job.status }}!
            Version: ${{ steps.version.outputs.version }}
            Run: ${{ github.run_number }}
            Commit: ${{ github.sha }}
          webhook_url: ${{ secrets.SLACK_WEBHOOK_URL }}
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}

      - name: Upload Android artifacts
        uses: actions/upload-artifact@v4
        with:
          name: android-dev-artifacts-${{ github.run_number }}
          path: |
            src-tauri/gen/android/**/*.apk
            src-tauri/gen/android/**/*.aab
          if-no-files-found: warn
          retention-days: 7

      - name: Cleanup keystore (Dev Build)
        if: always()
        run: |
          echo "ğŸ§¹ æ¸…ç†æ•æ„Ÿæ–‡ä»¶..."
          rm -rf android-keystore
          rm -f src-tauri/gen/android/app/keystore.properties
          echo "âœ… æ¸…ç†å®Œæˆ"

